# H∆∞·ªõng d·∫´n t∆∞∆°ng t√°c v·ªõi Backend - D·ª± √°n TiemTra

## üìã T·ªïng quan Architecture

D·ª± √°n n√†y l√† m·ªôt ·ª©ng d·ª•ng React TypeScript ph·ª•c v·ª• hai m·ª•c ƒë√≠ch ch√≠nh:
- **Giao di·ªán kh√°ch h√†ng**: Trang web b√°n h√†ng tr√† 
- **Giao di·ªán qu·∫£n tr·ªã**: Dashboard qu·∫£n l√Ω s·∫£n ph·∫©m, ƒë∆°n h√†ng, kh√°ch h√†ng

## üåê C·∫•u h√¨nh k·∫øt n·ªëi Backend

### URL Base
```typescript
// Development
const API_URL = "https://localhost:7021/api"

// Production (qua nginx proxy)
/api/ -> https://tiemtra-api-f5eue2bseraxefh8.southeastasia-01.azurewebsites.net
```

### C·∫•u tr√∫c URL API
```
/api/auth/*          - Authentication endpoints
/api/admin/*         - Admin management endpoints  
/api/store/*         - Store/Customer endpoints
```

## üîß H·ªá th·ªëng Service Layer

### 1. Axios Instance (`src/services/extended/axiosInstance.ts`)

ƒê√¢y l√† **tr√°i tim** c·ªßa vi·ªác giao ti·∫øp v·ªõi backend:

```typescript
const requester = axios.create({
  baseURL: API_URL,
  headers: { "Content-Type": "application/json" }
});

// Request Interceptor - T·ª± ƒë·ªông th√™m token
requester.interceptors.request.use((config) => {
  const excludedPaths = ["/auth/login", "/auth/register", "/auth/verify-otp"];
  if (!shouldExclude) {
    const token = getToken();
    if (token) {
      config.headers.Authorization = `Bearer ${token}`;
    }
  }
  return config;
});

// Response Interceptor - T·ª± ƒë·ªông refresh token
requester.interceptors.response.use(
  (response) => response,
  async (error) => {
    if (error.response.status === 401 && !originalRequest._retry) {
      // Th·ª≠ refresh token
      const refreshToken = getRefreshToken();
      const response = await authApi.refreshToken({ refreshToken });
      setTokens(response.data.token, response.data.refreshToken);
      
      // Retry request v·ªõi token m·ªõi
      originalRequest.headers.Authorization = `Bearer ${response.data.token}`;
      return axios(originalRequest);
    }
    return Promise.reject(error);
  }
);
```

**T√≠nh nƒÉng ch√≠nh:**
- ‚úÖ T·ª± ƒë·ªông attach JWT token v√†o m·ªçi request (tr·ª´ auth endpoints)
- ‚úÖ T·ª± ƒë·ªông refresh token khi h·∫øt h·∫°n (401 error)
- ‚úÖ Redirect v·ªÅ login page khi refresh th·∫•t b·∫°i

### 2. Constants Definition (`src/domain/constants/index.ts`)

T·∫≠p trung qu·∫£n l√Ω t·∫•t c·∫£ URL endpoints:

```typescript
const URL_ADMIN = `${BASE_URL}/api/admin`
const URL_AUTH = `${BASE_URL}/api`  
const URL_STORE = `${BASE_URL}/api/store`

export const AUTHENTICATION = {
  URL_API: {
    LOGIN_API: `${URL_AUTH}/auth/login`,
    REGISTER_API: `${URL_AUTH}/auth/register`,
    VERIFY_OTP: `${URL_AUTH}/auth/verify-otp`,
    REFRESH_TOKEN_API: `${URL_AUTH}/auth/refresh-token`,
    FORGOT_PASSWORD_API: `${URL_AUTH}/auth/forgot-password`,
    RESET_PASSWORD_API: `${URL_AUTH}/auth/reset-password`,
  }
}
```

**L·ª£i √≠ch:**
- ‚úÖ T·∫≠p trung qu·∫£n l√Ω URL, d·ªÖ maintain
- ‚úÖ TypeScript support v·ªõi dynamic URL functions  
- ‚úÖ Ph√¢n chia r√µ r√†ng theo domain (admin/store/auth)

## üèóÔ∏è Chi ti·∫øt t·ª´ng Service Module

### 1. Authentication Service (`src/services/api/Authentication/index.ts`)

```typescript
const authApi = {
  login: (params: { email: string; password: string }) =>
    requester.post(AUTHENTICATION.URL_API.LOGIN_API, params),
    
  register: (params: { fullName: string; email: string; password: string; phoneNumber: string }) =>
    requester.post(AUTHENTICATION.URL_API.REGISTER_API, params),
    
  verifyOtp: (params: { email: string; otp: string }) =>
    requester.post(AUTHENTICATION.URL_API.VERIFY_OTP, params),
    
  refreshToken: (params: { refreshToken: string }) =>
    requester.post(AUTHENTICATION.URL_API.REFRESH_TOKEN_API, params),
    
  forgotPassword: (params: { email: string }) =>
    requester.post(AUTHENTICATION.URL_API.FORGOT_PASSWORD_API, params),
    
  resetPassword: (params: { email: string; otp: string; newPassword: string }) =>
    requester.post(AUTHENTICATION.URL_API.RESET_PASSWORD_API, params),
};
```

**Workflow x√°c th·ª±c:**
1. `login` ‚Üí Nh·∫≠n token + refresh token + user data
2. L∆∞u v√†o localStorage: `access_token`, `refresh_token`, `user`
3. Middleware t·ª± ƒë·ªông attach token v√†o requests
4. Token h·∫øt h·∫°n ‚Üí T·ª± ƒë·ªông refresh
5. Refresh th·∫•t b·∫°i ‚Üí Redirect login

### 2. Product Service (`src/services/api/Products/indext.tsx`)

**Admin Product Operations:**
```typescript
const productApi = {
  // T·∫°o m√£ s·∫£n ph·∫©m t·ª± ƒë·ªông
  generateProductCode: () => 
    requester.get(ADMIN_PRODUCT.URL_API.GENERATE_PRODUCT_CODE),
    
  // Upload ·∫£nh s·∫£n ph·∫©m
  uploadImage: (file: File) => {
    const formData = new FormData();
    formData.append("file", file);
    return requester.post(ADMIN_PRODUCT.URL_API.UP_PRODUCT_IMAGE, formData, {
      headers: { "Content-Type": "multipart/form-data" }
    });
  },
  
  // CRUD operations
  createProduct: (data: CreateProductRequest) =>
    requester.post(ADMIN_PRODUCT.URL_API.CREATE_PRODUCT, data),
    
  getPagingProduct: (params: IProductFilter) => 
    requester.get(ADMIN_PRODUCT.URL_API.GET_ALL_PRODUCT, { params }),
    
  updateProduct: (id: string, data: CreateProductRequest) =>
    requester.put(ADMIN_PRODUCT.URL_API.UPDATE_PRODUCT(id), data),
    
  getByIdApi: (params: ProductRequest) => 
    requester.get(ADMIN_PRODUCT.URL_API.GET_BY_ID, { params }),
}
```

**Store Product Operations:**
```typescript
// Kh√°ch h√†ng xem s·∫£n ph·∫©m
storeGetAllProduct: (params: IProductFilter) => 
  requester.get(STORE_PPRODUCT.URL_API.GET_ALL_PRODUCT, { params }),

storeGetProductByCode: (productCode: string) => 
  requester.get(STORE_PPRODUCT.URL_API.GET_PRODUCT_BY_CODE(productCode))
```

**Interface ch√≠nh:**
```typescript
interface CreateProductRequest {
  productCode: string;
  productName: string;
  privewImageUrl: string;
  price?: number | null;
  stock?: number | null;
  description?: string;
  categoryId?: number;
  productImageUrls: string[];
  productAttributes?: ProductAttribute[];
  productVariations?: ProductVariation[];
  productStatus?: ProductStatus;
}

enum ProductStatus {
  Draft = 0,        // Nh√°p
  Active = 1,       // ƒêang b√°n
  Inactive = 2,     // Ng·ª´ng b√°n
  OutOfStock = 3,   // H·∫øt h√†ng
}
```

### 3. Category Service (`src/services/api/Category/index.tsx`)

```typescript
const categoryApi = {
  // Admin category management
  getPagingApi: (params: ICategoryRequest) =>
    requester.get(CATEGORY.URL_API.GET_ALL_API, { params }),
    
  addCategoryApi: (data: IAddCategoryRequest) =>
    requester.post(CATEGORY.URL_API.CREATE_API, data),
    
  updateCategoryApi: (id: number, data: IAddCategoryRequest) =>
    requester.put(CATEGORY.URL_API.UPDATE_API(id), data),
    
  // Bulk operations
  checkCanDeleteManyCategories: (ids: number[]) =>
    requester.post(CATEGORY.URL_API.CHECK_DELETE_BY_IDS, ids),
    
  deleteManyCategories: (ids: number[]) =>
    requester.delete(CATEGORY.URL_API.DELETE_API_BY_IDS, { data: ids }),
    
  // Category attributes relationship
  getAttributeById: (id: number) =>
    requester.get(CATEGORY.URL_API.ATTRIBUTE_BY_ID(id)),
    
  setAttributesForCategory: (data: { categoryId: number; attributeIds: number[] }) =>
    requester.post(CATEGORY.URL_API.SET_ATTRIBUTES_API, data),
    
  // Store-facing APIs
  getAllTree: () => 
    requester.get(STORE_CATEGORY.URL_API.GET_ALL), // Tree structure cho menu
};
```

### 4. Cart Service (`src/services/api/Cart/index.tsx`)

```typescript
const cartApi = {
  viewCart: () => 
    requester.get(STORE_CART.URL_API.VIEW_CART),
    
  addProductToCart: (data: AddProductToCart) =>
    requester.post(STORE_CART.URL_API.ADD_PRODUCT_TO_CART, data),
    
  updateQuantity: (data: AddProductToCart) =>
    requester.put(STORE_CART.URL_API.UPDATE_QUANTITY, data),
    
  removeCartItem: (cartItemId: string) =>
    requester.delete(STORE_CART.URL_API.REMOVE_CART_ITEM, {
      params: { cartItemId }
    }),
    
  getTotalQuantity: () => 
    requester.get(STORE_CART.URL_API.GET_TOTAL_QUANTITY),
};
```

**Cart Data Models:**
```typescript
interface ICartItem {
  cartItemId: string;
  productId: string;
  productVariationId: string;
  productCode: string;
  productName: string;
  productVariationName?: string;
  previewImage?: string;
  price: number;
  quantity: number;
}

interface AddProductToCart {
  productId: string;
  productVariationId?: string | null;
  quantity: number;
}
```

### 5. Order Service (`src/services/api/Order/index.tsx`)

```typescript
const orderApi = {
  // Store operations
  generateOrderCode: () => 
    requester.get(STORE_ORDER.URL_API.GENERATE_ORDER_CODE),
    
  createOrder: (data: ICreateOrder) =>
    requester.post(STORE_ORDER.URL_API.CREATE_ORDER, data),
    
  // Admin operations  
  getPagingOrder: (params: IOrderFilter) =>
    requester.get(ADMIN_ORDER.URL_API.GET_PAGING, { params }),
    
  comfirmOrder: (orderId: string) =>
    requester.post(ADMIN_ORDER.URL_API.COMFIRM_ORDER(orderId)),
    
  changeOrderStatus: (orderId: string, orderStatus: OrderStatus) =>
    requester.put(ADMIN_ORDER.URL_API.CHANGE_ORDER_STATUS(orderId), {
      newStatus: orderStatus
    }),
    
  getById: (orderId: string) =>
    requester.get(ADMIN_ORDER.URL_API.GET_BY_ID(orderId)),
};
```

**Order Status Workflow:**
```typescript
enum OrderStatus {
  Pending = 0,           // ƒêang ch·ªù x·ª≠ l√Ω
  Confirmed = 1,         // ƒê√£ x√°c nh·∫≠n  
  Shipped = 2,           // ƒêang giao h√†ng
  Delivered = 3,         // ƒê√£ giao h√†ng th√†nh c√¥ng
  DeliveryFailed = 4,    // Giao h√†ng kh√¥ng th√†nh c√¥ng
  CancelledByShop = 5,   // Shop h·ªßy
  CancelledByUser = 6,   // Kh√°ch h√†ng h·ªßy
  Refunded = 7,          // ƒê√£ ho√†n ti·ªÅn
}

enum PaymentMethod {
  COD = 0,              // Thanh to√°n khi nh·∫≠n h√†ng
  BankTransfer = 1,     // Chuy·ªÉn kho·∫£n
}
```

## üîê Authentication Flow chi ti·∫øt

### 1. Redux Store Setup (`src/views/Auth/store/index.tsx`)

```typescript
// Async thunks cho authentication
export const loginApi = createAsyncThunk(
  "auth/login",
  async (params: { email: string; password: string }, thunkAPI) => {
    try {
      const response = await authApi.login(params);
      const data = response.data;

      if (!data?.success || !data?.token) {
        return thunkAPI.rejectWithValue("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!");
      }

      // L∆∞u tokens v√† user data
      localStorage.setItem("access_token", data.token);
      localStorage.setItem("refresh_token", data.refreshToken || "");
      localStorage.setItem("user", JSON.stringify(data.data));
      
      // Clear cart khi ƒëƒÉng nh·∫≠p
      localStorage.removeItem("cart");

      return data;
    } catch (error: any) {
      return thunkAPI.rejectWithValue(error.response?.data?.message);
    }
  }
);
```

### 2. Token Management

**L∆∞u tr·ªØ:**
```typescript
// localStorage keys:
- "access_token": JWT token ch√≠nh
- "refresh_token": Token ƒë·ªÉ refresh
- "user": User data object
```

**Lu·ªìng refresh token:**
```typescript
// Khi API tr·∫£ 401
if (error.response.status === 401 && !originalRequest._retry) {
  originalRequest._retry = true;
  
  try {
    const refreshToken = getRefreshToken();
    const response = await authApi.refreshToken({ refreshToken });
    
    // C·∫≠p nh·∫≠t tokens m·ªõi
    setTokens(response.data.token, response.data.refreshToken);
    
    // Retry request g·ªëc v·ªõi token m·ªõi
    originalRequest.headers.Authorization = `Bearer ${response.data.token}`;
    return axios(originalRequest);
  } catch (refreshError) {
    // Refresh th·∫•t b·∫°i ‚Üí Logout + redirect login
    localStorage.clear();
    window.location.href = "/login";
  }
}
```

### 3. Protected Routes

```typescript
const ProtectedRoute = ({ children, requiredRole }: ProtectedRouteProps) => {
  const storedUser = localStorage.getItem("user");
  const user = storedUser ? JSON.parse(storedUser) : null;

  if (!user) {
    return <UnauthorizedPage />;
  }

  if (requiredRole && !user.roles?.includes(requiredRole)) {
    return <UnauthorizedPage message="B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p" />;
  }

  return <>{children}</>;
};

// Usage:
<Route 
  path="/admin" 
  element={
    <ProtectedRoute requiredRole="Admin">
      <AdminDashboard />
    </ProtectedRoute>
  }
/>
```

## üìä State Management Strategy

### 1. Authentication State (Redux)
```typescript
// Ch·ªâ auth state d√πng Redux
interface AuthState {
  user: UserType | null;
  loading: boolean;
  error: string | null;
}
```

### 2. Server State (React Query)
```typescript
// T·∫•t c·∫£ data t·ª´ server d√πng React Query
const { data: products, isLoading } = useQuery({
  queryKey: ['products', filters],
  queryFn: () => productApi.getPagingProduct(filters)
});
```

### 3. Local State (localStorage)
```typescript
// Cart data l∆∞u local (cho guest users)
const cartData = localStorage.getItem("cart");
```

## üõ†Ô∏è Patterns v√† Best Practices

### 1. Error Handling
```typescript
// T·∫•t c·∫£ API calls c√≥ try-catch
try {
  const response = await productApi.createProduct(data);
  // Success handling
} catch (error: any) {
  const message = error.response?.data?.message || "C√≥ l·ªói x·∫£y ra";
  // Error handling v·ªõi user-friendly message
}
```

### 2. Loading States
```typescript
// D√πng React Query loading states
const { data, isLoading, error } = useQuery(/*...*/);

if (isLoading) return <CircularProgress />;
if (error) return <ErrorMessage />;
```

### 3. Type Safety
```typescript
// T·∫•t c·∫£ API calls c√≥ TypeScript interfaces
interface IProductFilter {
  pageNumber?: number;
  pageSize?: number;
  keyword?: string;
  categoryId?: number;
  status?: ProductStatus;
}
```

### 4. File Upload Pattern
```typescript
const uploadImage = async (file: File) => {
  const formData = new FormData();
  formData.append("file", file);
  
  return requester.post(ADMIN_PRODUCT.URL_API.UP_PRODUCT_IMAGE, formData, {
    headers: { "Content-Type": "multipart/form-data" }
  });
};
```

## üéØ K·∫øt lu·∫≠n

H·ªá th·ªëng n√†y ƒë∆∞·ª£c thi·∫øt k·∫ø v·ªõi:
- ‚úÖ **Separation of Concerns**: Admin vs Store APIs r√µ r√†ng
- ‚úÖ **Automatic Token Management**: Kh√¥ng c·∫ßn th·ªß c√¥ng handle tokens
- ‚úÖ **Type Safety**: Full TypeScript support
- ‚úÖ **Error Resilience**: Auto retry v·ªõi refresh token
- ‚úÖ **Scalable Architecture**: D·ªÖ extend th√™m services

**ƒê·ªÉ h·ªçc t·ªët project n√†y, sinh vi√™n n√™n:**
1. üìñ ƒê·ªçc k·ªπ `axiosInstance.ts` ƒë·ªÉ hi·ªÉu token management
2. üîç Trace flow t·ª´ UI component ‚Üí Service ‚Üí API ‚Üí Backend  
3. üß™ Test authentication flow: login ‚Üí token refresh ‚Üí logout
4. üìù Practice t·∫°o service m·ªõi theo pattern c√≥ s·∫µn
5. üîß Hi·ªÉu c√°ch Redux + React Query complement nhau
